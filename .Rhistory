echart(option)
}
vis_bar(data['201501'])
readtestdata = function()
{
testdata = read.csv('d:/testbar.csv')
testdata = xts(testdata[,2:7],order.by=as.POSIXct(testdata$date))
return(testdata)
}
vis_bar = function(data)
{
tooltip_formatter = JS("function (param) {
param = param[0];
return [
'Date: ' + param.name + '<br/>',
'Open: ' + param.data[0] + '<br/>',
'Close: ' + param.data[1] + '<br/>',
'Lowest: ' + param.data[2] + '<br/>',
'Highest: ' + param.data[3] + '<br/>'
].join('');
}")
tooltip_formatter = gsub('\n','',tooltip_formatter)
axisPointer_formatter = JS("function (params) {
var seriesValue = (params.seriesData[0] || {}).value;
return params.value
+ (seriesValue != null
? '\n' + echarts.format.addCommas(seriesValue)
: ''
);
}
")
axisPointer_formatter = gsub('\n','',axisPointer_formatter)
posiont_tooltip = JS("function(pos, params, el, elRect, size) {
var obj = {top: 10};
obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
return obj;
}")
posiont_tooltip = gsub('\n',' ',posiont_tooltip)
stock = data
stock$sma10 = SMA(Cl(stock),10)
stock$cci = CCI(HLC(stock),10)
#stock = na.omit(stock)
dates = as.character(index(stock))
data = as.data.frame(OHLC(stock))
data = data[,c('Open','Close','Low','High')]
rownames(data) = NULL
colnames(data) = NULL
data = as.matrix(data)
xx = apply(data,1,as.list)
ma = as.numeric(stock$sma10)
cci = ma#as.numeric(stock$cci)
option = list(
backgroundColor= '#eee',
animation= F,
legend= list(
bottom= 10,
left= 'center',
data= c('Dow-Jones index', 'MA5')
),
tooltip= list(
trigger= 'axis',
axisPointer= list(
animation = F,
type= 'cross'
),
backgroundColor= 'rgba(245, 245, 245, 0.8)',
borderWidth= 1,
borderColor= '#ccc',
padding= 10,
textStyle= list(
color= '#000'
),
#position = posiont_tooltip,
extraCssText= 'width= 170px'
),
axisPointer= list(
link= list(xAxisIndex= 'all'),
label= list(
backgroundColor= '#777'
)
),
toolbox= list(
feature= list(
dataZoom= list(
yAxisIndex= F
),
brush= list(
type= c('lineX', 'clear')
)
)
),
brush= list(
xAxisIndex= 'all',
brushLink= 'all',
outOfBrush= list(
colorAlpha= 0.1
)
),
grid= list(
list(
left= '10%',
right= '8%',
height= '50%'
),
list(
left= '10%',
right= '8%',
top= '63%',
height= '16%'
)
),
xAxis= list(
list(
type= 'category',
data= dates,#data.categoryData,
scale= T,
boundaryGap = F,
axisLine= list(onZero= F),
splitLine= list(show= F),
splitNumber= 20,
min= 'dataMin',
max= 'dataMax',
axisPointer= list(
z= 100
)
),
list(
type= 'category',
gridIndex= 1,
data= dates,#data.categoryData,
scale= T,
boundaryGap = T,
axisLine= list(onZero= T),
axisTick= list(show= T),
splitLine= list(show= T),
axisLabel= list(show= T),
#splitNumber= 20,
min= 'dataMin',
max= 'dataMax',
axisPointer= list(
label= list(
#   z = 100
#formatter = axisPointer_formatter
)
)
)
),
yAxis= list(
list(
scale= T,
splitArea= list(
show= T
)
),
list(
scale= T,
gridIndex= 1,
splitNumber= 2,
axisLabel= list(show= T),
axisLine= list(show= T),
axisTick= list(show= T),
splitLine= list(show= T)
)
),
dataZoom= list(
list(
type= 'inside',
xAxisIndex= c(0, 1),
start= 98,
end= 100
),
list(
show= T,
xAxisIndex= c(0, 1),
type= 'slider',
top= '85%',
start= 98,
end= 100
)
),
series= list(
list(
name= 'index',
type= 'k',
data= xx,
itemStyle= list(
normal= list(
borderColor= null,
borderColor0= null
)
),
tooltip= list(
)
),
list(
name= 'MA5',
type= 'line',
data= ma,
smooth= T,
lineStyle= list(
normal= list(opacity= 0.5)
)
),
list(
name= 'cci',
type= 'line',
data= cci,
smooth= T,
lineStyle= list(
normal= list(opacity= 0.5)
),
xAxisIndex= 1,
yAxisIndex= 1
)
)
)
echart(option)
}
vis_bar(data['201501'])
require(quantmod)
require(quantmod)
getMysqlCon = function(dbname)
{
host = '127.0.0.1'
username="root"
password = '123456'
port = 3306
conn = dbConnect(MySQL(), dbname = dbname, username=username, password=password,host=host,port=port)
return(conn)
}
writeToMysqltable = function(data,dbname,tbname,overwrite = F)
{
conn = getMysqlCon(dbname)
returnvalue = dbWriteTable(conn,tbname,data,overwrite=overwrite,row.names = F)
dbDisconnect(conn)
return(returnvalue)
}
getTableData = function(dbname,tbname)
{
conn = getMysqlCon(dbname)
data = dbReadTable(conn,tbname)
dbDisconnect(conn)
return(data)
}
getdata = function(dbname,tbname,freq=15,isxts=T)
{
#dbname = 'china_future_ods_m'
#tbname = 'dlcmi'
data = getTableData(dbname,tbname)
if(isxts)
{
data = xts(data[,c('Open','High','Low','Close','Vol','Oi')],order.by=as.POSIXct(data$datetime,format='%Y-%m-%d %H:%M:%S'))
}
if(freq != 1)
{
data = to_minutes(data,freq)
}
return(data)
}
# d like '2015-02'
getMonthEnd = function(d)
{
require('lubridate')
nd = paste(d,'01',sep='-')
nd = ymd(nd) + months(1)
nd = nd  - days(1)
return(as.Date(nd))
}
#大陆期货夜盘，分钟转日处理函数
to_day = function(pricedata)
{
days = as.character(unique(substr(as.character(index(pricedata)),1,10)))
day = days[1]
price = pricedata[day]
open = as.numeric(price[1,]$Open)
high = max(as.numeric(price$High))
low = min(as.numeric(price$Low))
close = tail(price,1)$Close
vol = sum(as.numeric(price$Vol))
oi = tail(price,1)$Oi
rs = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = as.Date(day))
for(i in 2:length(days))
{
preday = days[i-1]
day = days[i]
starttime = paste(preday,'21:00:00')
endtime = paste(day,'15:00:00')
timespan = paste(starttime,endtime,sep='/')
price = pricedata[timespan]
if(nrow(price) == 0) next #可能只有夜盘
open = as.numeric(price[1,]$Open)
high = max(as.numeric(price$High))
low = min(as.numeric(price$Low))
close = tail(price,1)$Close
vol = sum(as.numeric(price$Vol))
oi = tail(price,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = as.Date(day))
rs = rbind(rs,r)
}
return(rs)
}
#处理后对齐的数据
to_minutes = function(pricedata,k=5)
{
times = index(pricedata)
i = 1
newtime =  times[i]
ps = pricedata[i:(i+k-1)]
open = as.numeric(ps[1,]$Open)
high = max(as.numeric(ps$High))
low = min(as.numeric(ps$Low))
close = tail(ps,1)$Close
vol = sum(as.numeric(ps$Vol))
oi = tail(ps,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = newtime)
rs = r
i = i + k
while(i < length(times))
{
# print(i)
newtime =  times[i]
ps = pricedata[i:(i+k-1)]
open = as.numeric(ps[1,]$Open)
high = max(as.numeric(ps$High))
low = min(as.numeric(ps$Low))
close = tail(ps,1)$Close
vol = sum(as.numeric(ps$Vol))
oi = tail(ps,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = newtime)
rs = rbind(rs,r)
i = i + k
}
return(rs)
}
#获取交易区间时间
get_day_trade_min_series = function(freq=15)
{
by = paste(freq,'min')
time = seq(as.POSIXct('2001-01-01 09:00:00'),as.POSIXct('2001-01-01 15:00:00'),by=by)
time = as.character(time)
time = substr(time,12,19)
return(time)
}
dbname ='china_future_ods_m'
tbname = 'dlami'
freq = 15
orgin_data = getdata(dbname,tbname,freq)
require(RMySQL)
require(quantmod)
require(RMySQL)
getMysqlCon = function(dbname)
{
host = '127.0.0.1'
username="root"
password = '123456'
port = 3306
conn = dbConnect(MySQL(), dbname = dbname, username=username, password=password,host=host,port=port)
return(conn)
}
writeToMysqltable = function(data,dbname,tbname,overwrite = F)
{
conn = getMysqlCon(dbname)
returnvalue = dbWriteTable(conn,tbname,data,overwrite=overwrite,row.names = F)
dbDisconnect(conn)
return(returnvalue)
}
getTableData = function(dbname,tbname)
{
conn = getMysqlCon(dbname)
data = dbReadTable(conn,tbname)
dbDisconnect(conn)
return(data)
}
getdata = function(dbname,tbname,freq=15,isxts=T)
{
#dbname = 'china_future_ods_m'
#tbname = 'dlcmi'
data = getTableData(dbname,tbname)
if(isxts)
{
data = xts(data[,c('Open','High','Low','Close','Vol','Oi')],order.by=as.POSIXct(data$datetime,format='%Y-%m-%d %H:%M:%S'))
}
if(freq != 1)
{
data = to_minutes(data,freq)
}
return(data)
}
# d like '2015-02'
getMonthEnd = function(d)
{
require('lubridate')
nd = paste(d,'01',sep='-')
nd = ymd(nd) + months(1)
nd = nd  - days(1)
return(as.Date(nd))
}
#大陆期货夜盘，分钟转日处理函数
to_day = function(pricedata)
{
days = as.character(unique(substr(as.character(index(pricedata)),1,10)))
day = days[1]
price = pricedata[day]
open = as.numeric(price[1,]$Open)
high = max(as.numeric(price$High))
low = min(as.numeric(price$Low))
close = tail(price,1)$Close
vol = sum(as.numeric(price$Vol))
oi = tail(price,1)$Oi
rs = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = as.Date(day))
for(i in 2:length(days))
{
preday = days[i-1]
day = days[i]
starttime = paste(preday,'21:00:00')
endtime = paste(day,'15:00:00')
timespan = paste(starttime,endtime,sep='/')
price = pricedata[timespan]
if(nrow(price) == 0) next #可能只有夜盘
open = as.numeric(price[1,]$Open)
high = max(as.numeric(price$High))
low = min(as.numeric(price$Low))
close = tail(price,1)$Close
vol = sum(as.numeric(price$Vol))
oi = tail(price,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = as.Date(day))
rs = rbind(rs,r)
}
return(rs)
}
#处理后对齐的数据
to_minutes = function(pricedata,k=5)
{
times = index(pricedata)
i = 1
newtime =  times[i]
ps = pricedata[i:(i+k-1)]
open = as.numeric(ps[1,]$Open)
high = max(as.numeric(ps$High))
low = min(as.numeric(ps$Low))
close = tail(ps,1)$Close
vol = sum(as.numeric(ps$Vol))
oi = tail(ps,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = newtime)
rs = r
i = i + k
while(i < length(times))
{
# print(i)
newtime =  times[i]
ps = pricedata[i:(i+k-1)]
open = as.numeric(ps[1,]$Open)
high = max(as.numeric(ps$High))
low = min(as.numeric(ps$Low))
close = tail(ps,1)$Close
vol = sum(as.numeric(ps$Vol))
oi = tail(ps,1)$Oi
r = xts(data.frame(Open=open,High=high,Low=low,Close=close,Vol=vol,Oi=oi), order.by = newtime)
rs = rbind(rs,r)
i = i + k
}
return(rs)
}
#获取交易区间时间
get_day_trade_min_series = function(freq=15)
{
by = paste(freq,'min')
time = seq(as.POSIXct('2001-01-01 09:00:00'),as.POSIXct('2001-01-01 15:00:00'),by=by)
time = as.character(time)
time = substr(time,12,19)
return(time)
}
orgin_data = getdata(dbname,tbname,freq)
host = '127.0.0.1'
username="root"
password = '123456'
port = 3306
conn = dbConnect(MySQL(), dbname = dbname, username=username, password=password,host=host,port=port)
conn.colose()
close(conn)
dbname = 'china_future_ods_m'
tbname = 'dlcmi'
host = '127.0.0.1'
username="root"
password = '123456'
port = 3306
conn = dbConnect(MySQL(), dbname = dbname, username=username, password=password,host=host,port=port)
data = dbReadTable(conn,tbname)
?ATR
data = getTableData(dbname,tbname)
data = to_minutes(data,freq)
data = xts(data[,c('Open','High','Low','Close','Vol','Oi')],order.by=as.POSIXct(data$datetime,format='%Y-%m-%d %H:%M:%S'))
data = to_minutes(data,freq)
head(data)
xx = as.data.frame(data)
head(xx)
xx$date = rownames(xx)
head(xx)
data$cci = CCI(data)
?CCI
data = xts(data[,c('Open','High','Low','Close','Vol','Oi')],order.by=as.POSIXct(data$datetime,format='%Y-%m-%d %H:%M:%S'))
data = orgin_data
dbname ='china_future_ods_m'
tbname = 'dlami'
freq = 15
orgin_data = getdata(dbname,tbname,freq)
data = orgin_data
data$cci = CCI(data)
data$cci = CCI(HLC(data),20)
data$sma = SMA(Cl(data),20)
data = as.data.frame(data)
data$Date = rownames(data)
