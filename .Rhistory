day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.5)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
stopratio = 2
profitratio =2
stop_long = round(op - stopratio*atr)
stop_short = round(op + stopratio*atr)
profit_long = round(op + profitratio*atr)
profit_short = round(op - profitratio*atr)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit[profit>0])/length(profit)
aggregate(profit,by = list(points_result$center),sum)
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 13
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.5)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit[profit>0])/length(profit)
aggregate(profit,by = list(points_result$center),sum)
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 13
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.2)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit[profit>0])/length(profit)
length(profit)
n = 20
set.seed(1234)
clust = pam(result,n)
centers_index = clust$id.med
centers_scale = result[centers_index,]
labels = clust$clustering
centers = xx[centers_index,]
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 9
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.5)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit)
length(profit[profit>0])/length(profit)
aggregate(profit,by = list(points_result$center),sum)
length(profit[profit>0])/length(profit)
n = 10
set.seed(1234)
clust = pam(result,n)
centers_index = clust$id.med
centers_scale = result[centers_index,]
labels = clust$clustering
centers = xx[centers_index,]
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 9
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.5)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit)
length(profit[profit>0])/length(profit)
xx_dcast = flat_time_data(data,diffclose='median',freq=freq)
xx = xx_dcast[,2:ncol(xx_dcast)]
indices = which(apply(xx,MARGIN=1,function(x)(all(as.numeric(x)==x[1]))))
if(length(indices) > 0 )
{
xx=xx[-indices,]
xx_dcast =xx_dcast[-indices,]
}
xx_scaled = apply(xx,MARGIN=1,function(x){return(rbind(as.numeric(scale(as.numeric(x)))))})
xx_scaled = t(xx_scaled)
result = data.frame()
x = 1:15
x = as.vector(scale(x))
ht <- seq(min(x), max(x), length.out = 225)
for(i in 1:nrow(xx_scaled))
{
nsample =i
y=xx_scaled[nsample,1:15]
fm = lm(y ~ bs(x, df = 5))
points = predict(fm, data.frame(x = ht))
result = rbind(result,points)
}
n = 15
set.seed(1234)
clust = pam(result,n)
centers_index = clust$id.med
centers_scale = result[centers_index,]
labels = clust$clustering
centers = xx[centers_index,]
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 9
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.5)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit)
length(profit[profit>0])/length(profit)
points_result = data.frame()
for(i in 1:nrow(xx))
{
predict_point = 9
start_point = predict_point + 1
v = as.numeric(xx[i,])
day = xx_dcast[i,]$day
tmp = tryCatch(predict_center(v,centers,centers_scale,predict_point,ht,x,F),error=function(e) e)
if(inherits(tmp, "error")) next
center_pr = tmp
strategy = center_strategy(centers_scale,center_pr,ht,predict_point,threshold=0.8)
if(strategy == 'normal') next
day_data = data[day]
open = as.numeric(day_data[1,]$Open)
op = as.numeric(day_data[start_point,]$Open)
cl = as.numeric(day_data[15,]$Close)
hi = max(as.numeric(day_data[start_point:15,]$High))
low = min(as.numeric(day_data[start_point:15,]$Low))
sd = sd(as.numeric(day_data[1:predict_point,]$Close))
atr = as.numeric(ATR(HLC(day_data[1:predict_point,]),n=5)$atr)
atr = round(atr[length(atr)])
sd = round(sd)
stopratio = 2
profitratio =2
var = atr
stop_long = round(op - stopratio*var)
stop_short = round(op + stopratio*var)
profit_long = round(op + profitratio*var)
profit_short = round(op - profitratio*var)
type = 'normal'
for(j in start_point:15)
{
curbar = day_data[j,]
curhigh = curbar$High
curlow = curbar$Low
if(strategy == 'short' && curhigh >= stop_short)
{
cl = stop_short
type = 'stopshort'
break
}
else if(strategy == 'short' && curlow <= profit_short)
{
cl = profit_short
type = 'profitshort'
break
}
else if(strategy == 'long' && curlow <= stop_long)
{
cl = stop_long
type = 'stoplong'
break
}
else if(strategy == 'long' && curhigh >= profit_long)
{
cl = profit_long
type = 'profitlong'
break
}
}
profit = ifelse(strategy == 'long',(cl-op),(op-cl))
r = data.frame(i=i,day=day,center = center_pr,open=open,op=op,hi = hi,low=low,cl=cl,profit=profit,atr=atr,strategy=strategy,type=type)
points_result = rbind(points_result,r)
}
profit = points_result$profit
sum(profit)
length(profit)
